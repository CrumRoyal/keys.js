(function(f,m,k){"object"===typeof exports&&(exports=m(exports));"function"===typeof define?define(function(){return m(f)}):f=m(f)})(this,function(f,m){function k(a,d){for(var b=0;b<a.length;b++)if(d(a[b]))return a[b];return null}function b(a,d){this.name=a;this.code=d;b.internals.keymap[a]=b.internals.keymap[a]||d}function c(a,d){function g(a,d){return null!==k(a,function(a){return d.eq(a)})}var e=null;if(2===arguments.length&&d instanceof Array)e=d;else if(2<=arguments.length)e=Array.prototype.slice.call(arguments,
1);else{if(1===arguments.length)throw Error("Combo: At least one meta key is required for a Combo");throw Error("Combo: Invalid number of arguments provided.");}if(k(e,function(a){switch(a.code){case b.CTRL.code:case b.SHIFT.code:case b.ALT.code:case b.META.code:case b.META_RIGHT.code:return!1;default:return!0}}))throw Error("Combo: Attempted to create a Combo with multiple non-meta Keys. This is not supported.");this.key=a;this.ctrl=g(e,b.CTRL)||a.eq(b.CTRL);this.shift=g(e,b.SHIFT)||a.eq(b.SHIFT);
this.alt=g(e,b.ALT)||a.eq(b.ALT);this.meta=(this.meta=g(e,b.META)||g(e,b.META_RIGHT))||a.eq(b.META)||a.eq(b.META_RIGHT)}function h(){var a=this;document.addEventListener("keydown",function(d){d.stopImmediatePropagation();var b=c.fromEvent(d);a.getHandlersForCombo(b).filter(function(a){return"keydown"===a.eventType}).tap(function(a){l("Bindings.handleKeydown called for Combo: "+b.toString()+". Handler `"+a.name+"` was called.")},!0).forEach(function(a){a.handler()});return!1},!0);document.addEventListener("keyup",
function(d){d.stopImmediatePropagation();var b=c.fromEvent(d);a.getHandlersForCombo(b).filter(function(a){return"keyup"===a.eventType}).tap(function(a){l("Bindings.handleKeyup called for Combo: "+b.toString()+". Handler `"+a.name+"` was called.")},!0).forEach(function(a){a.handler()});return!1},!0);this.bindings=[];this.handlers=[]}f=f||{};f.debug=!1;Function.prototype.bind||(Function.prototype.bind=function(a){var d=this;return function(){var b=Array.prototype.slice.call(arguments);return d.apply(a,
b)}});var l=function(){var a=console?console.log.bind(console):Function.prototype.valueOf();return function(){if(f.debug){var d=Array.prototype.slice.call(arguments);a.apply(null,d)}}}();(function(){var a=console?console.warn.bind(console):Function.prototype.valueOf();return function(){var d=Array.prototype.slice.call(arguments);a.apply(null,d)}})();Array.prototype.forEach||(Array.prototype.forEach=function(a,d,b){if(!a)throw Error("forEach: Array is null or undefined.");if("function"!==typeof d)throw Error("forEach: Iterator is not callable.");
var e=a.length>>>0,c=0;for(b=b||null;c<e;)Object.prototype.hasOwnProperty.call(a,c)&&d.call(b,a[c],c,a),c++});Array.prototype.map||(Array.prototype.map=function(a,d){var b=[];a.forEach(function(a,c,f){b.push(d.call(null,a,c,f))});return b});Array.prototype.filter||(Array.prototype.filter=function(a,b,g){if("function"!==typeof b)throw Error("Predicate is not callable.");var e=[];a.forEach(function(a,c,f){b.call(g,a,c,f)&&e.push(a)});return e});Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===
this)throw new TypeError;var b=Object(this),g=b.length>>>0;if(0===g)return-1;var e=0;0<arguments.length&&(e=Number(arguments[1]),e!=e?e=0:0!==e&&(Infinity!=e&&-Infinity!=e)&&(e=(0<e||-1)*Math.floor(Math.abs(e))));if(e>=g)return-1;for(e=0<=e?e:Math.max(g-Math.abs(e),0);e<g;e++)if(e in b&&b[e]===a)return e;return-1});Array.prototype.tap=function(a,b){(!b||f.debug)&&this.slice().forEach(function(b){a.call(null,b)});return this};Array.prototype.zipmap=function(){var a=Array.prototype.slice.call(arguments);
return this.map(function(b,g){for(var e=[],c=0;c<a.length;c++){var f=a[c]&&a[c][g];e.push(null!==f&&"undefined"!==typeof f?f:null)}return[b].concat(e)})};String.prototype.endsWith=function(a){return this.length-a.length===this.lastIndexOf(a)?!0:!1};b.internals={};b.internals.keymap={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,
"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,Multiply:106,Add:107,Subtract:109,Decimal:110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F11:122,F12:123,F13:124,F14:125,F15:126,Backspace:8,Tab:9,Enter:13,SHIFT:16,CTRL:17,ALT:18,META:91,META_RIGHT:93,"Caps Lock":20,Esc:27,Spacebar:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,"Num Lock":144,ScrLk:145,"Pause/Break":19,
"; :":186,"= +":187,",":188,"- _":189,".":190,"/ ?":191,"` ~":192,"[ {":219,"\\ |":220,"] }":221,"\" '":222};for(var n in b.internals.keymap)b[n]=new b(n,b.internals.keymap[n]);b.fromName=function(a){return(a=b[a])&&a instanceof b?a:null};b.fromCode=function(a){for(var d in b.internals.keymap)if(b.internals.keymap[d]===a)return b[d];return null};b.prototype.isPressed=function(a){return this.code===a};b.prototype.isMeta=function(){switch(this.code){case b.CTRL.code:case b.SHIFT.code:case b.ALT.code:case b.META.code:case b.META_RIGHT.code:return!0;
default:return!1}};b.prototype.eq=function(a){return this.code===a.code&&this.name===a.name};f.Key=b;c.prototype.toString=function(){var a=(this.ctrl?"CTRL+":"")+(this.alt?"ALT+":"")+(this.shift?"SHIFT+":"")+(this.meta?"META+":"");return this.key.isMeta()?a.endsWith("+")?a.slice(0,a.length-1):a:a+(this.key&&this.key.name?this.key.name:"")};c.prototype.serialize=function(){if("undefined"===typeof JSON)throw Error("Your browser does not currently support JSON serialization.");return JSON.stringify(this)};
c.deserialize=function(a){if("undefined"===typeof JSON)throw Error("Your browser does not currently support JSON deserialization.");a=JSON.parse(a);return c.fromObject(a)};c.prototype.clone=function(){var a=new c(this.key);a.ctrl=this.ctrl;a.alt=this.alt;a.shift=this.shift;a.meta=this.meta;return a};c.fromObject=function(a){if(!a||!a.key)throw Error("Combo.fromObject: Cannot create Combo from provided object");var d=new b(a.key.name,a.key.code);a=[b.CTRL,b.ALT,b.SHIFT,b.META].zipmap([a.ctrl,a.alt,
a.shift,a.meta]).filter(function(a){return!0===a[1]}).map(function(a){return a[0]});return new c(d,a)};c.fromEvent=function(a){var d=b.fromCode(a.which),g=new c(d);g.shift=a.shiftKey||d.eq(b.SHIFT);g.alt=a.altKey||d.eq(b.ALT);g.meta=a.metaKey||d.eq(b.META)||d.eq(b.META_RIGHT);g.ctrl=a.ctrlKey||d.eq(b.CTRL);return g};c.fromString=function(a){a=a.split("+");if(1<=a.length){var d=new c(b.fromName(a[a.length-1]));d.ctrl=-1<a.indexOf("CTRL");d.alt=-1<a.indexOf("ALT");d.shift=-1<a.indexOf("SHIFT");d.meta=
-1<a.indexOf("META")||-1<a.indexOf("META_RIGHT");return d}throw Error("Combo.fromString: Invalid string");};c.prototype.eq=function(a){return!a||!(a instanceof c)?!1:this.key.eq(a.key)?this.shift!==a.shift?!1:this.alt!==a.alt?!1:this.ctrl!==a.ctrl?!1:this.meta!==a.meta?!1:!0:!1};c.prototype.isMatch=function(a,d){if(!a)throw Error("Combo.isMatch called without a combo to match against.");if(this.key.isMeta()){if((this.shift||this.key.eq(b.SHIFT))&&!a.shift||(this.alt||this.key.eq(b.ALT))&&!a.alt||
(this.ctrl||this.key.eq(b.CTRL))&&!a.ctrl||(this.meta||this.key.eq(b.META)||this.key.eq(b.META_RIGHT))&&!a.meta)return!1}else if(!d&&!this.key.eq(a.key)||this.shift&&!a.shift||this.alt&&!a.alt||this.ctrl&&!a.ctrl||this.meta&&!a.meta)return!1;return!0};c.prototype.requires=function(a){if("number"!==typeof a)throw Error("Combo.requires: `which` must be a keycode (number)");return this.key.code===a?!0:this.ctrl&&this.key.eq(b.CTRL)?!0:this.shift&&this.key.eq(b.SHIFT)?!0:this.alt&&this.key.eq(b.ALT)?
!0:this.meta&&(this.key.eq(b.META)||key.eq(b.META_RIGHT))?!0:!1};c.prototype.containsMetaKeys=function(){return this.ctrl||this.shift||this.alt||this.meta||this.key.isMeta()};f.Combo=c;h.prototype.get=function(a){return k(this.bindings,function(b){return b.name===a})};h.prototype.add=function(a,b){if(!a||!b)throw Error("Keybindings.add: Invalid arguments provided");if(!(b instanceof c))throw Error("Keybindings.add: `combo` must be an instance of Combo");var g=k(this.bindings,function(b){return b.name===
a});g?(g.combo=b,l("Bindings.add: Updated existing binding - `"+a+"` with Combo: "+b.toString())):(this.bindings.push({name:a,combo:b}),l("Bindings.add: New binding - `"+a+"` with Combo: "+b.toString()))};h.prototype.registerHandler=function(a,b,c){2===arguments.length&&"function"===typeof b&&(c=b,b="keydown");if(!a||!b||!c||"function"!==typeof c)throw Error("Keybindings.registerHandler: Invalid arguments provided");this.handlers.push({name:a,eventType:b,handler:c});l("Bindings.registerHandler: Handler `"+
a+"` registered for `"+b+"` events.")};h.prototype.registerToggle=function(a,b,c){if(3!==arguments.length)throw Error("Keybindings.registerToggle: You must provide all three arguments to this function.");this.handlers.push({name:a,eventType:"keydown",handler:function(){var a=!1;return function(){var f=Array.prototype.slice.call(arguments);a?(a=!1,c.apply(null,f)):(a=!0,b.apply(null,f))}}()});l("Bindings.registerToggle: Toggle `"+a+"` registered.")};h.prototype.serialize=function(){if("undefined"===
typeof JSON)throw Error("Your browser does not support JSON serialization.");return JSON.stringify(this)};h.prototype.deserialize=function(a){if("undefined"===typeof JSON)throw Error("Your browser does not support JSON serialization.");a=JSON.parse(a);if(!a||!a.bindings||a instanceof Array)throw Error("Keybindings.deserialize: Unable to deserialize keybindings");this.bindings=a.bindings.map(function(a){a.combo=c.fromObject(a.combo);return a})};h.prototype.getHandlersForCombo=function(a,b){var c=this.bindings.filter(function(c){return b?
c.combo.isMatch(a,!0):c.combo.isMatch(a)});return this.handlers.filter(function(a){return k(c,function(b){return b.name===a.name})})};f.Bindings=h;return f});
