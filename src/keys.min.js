(function(g,f,p){"object"===typeof exports&&(exports=f(g,exports));"function"===typeof define?define("Keys",null,function(){return f(g)}):g.Keys=f(g)})(this,function(g,f,p){function l(a,c){for(var b=0;b<a.length;b++)if(c(a[b]))return a[b];return null}function b(a,c){this.name=a;this.code=c}function e(a,c){function m(a,c){return null!==l(a,function(a){return c.eq(a)})}var d=null;if(2===arguments.length&&c instanceof Array)d=c;else if(2<=arguments.length)d=Array.prototype.slice.call(arguments,1);else{if(1===
arguments.length)return this.key=a,this.ctrl=a.eq(b.CTRL),this.shift=a.eq(b.SHIFT),this.alt=a.eq(b.ALT),this.meta=a.eq(b.META)||a.eq(b.META_RIGHT),this;throw Error("Combo: Invalid number of arguments provided.");}this.key=a;this.ctrl=m(d,b.CTRL);this.shift=m(d,b.SHIFT);this.alt=m(d,b.ALT);this.meta=m(d,b.META)||m(d,b.META_RIGHT);l(d,function(a){switch(a.code){case b.CTRL.code:case b.SHIFT.code:case b.ALT.code:case b.META.code:case b.META_RIGHT.code:return!1;default:return!0}})&&k.warn("Warning: You have attempted to create a Combo using multiple non-meta Keys. This is not currently supported.")}
function h(){var a=this;g.document.addEventListener("keydown",function(c){c.stopImmediatePropagation();c=e.fromEvent(c);a.getHandlersForCombo(c).filter(function(a){return"keydown"===a.eventType}).forEach(function(a){a.handler()});return!1},!0);g.document.addEventListener("keyup",function(c){c.stopImmediatePropagation();c=e.fromEvent(c);a.getHandlersForCombo(c).filter(function(a){return"keyup"===a.eventType}).forEach(function(a){a.handler()});return!1},!0);this.bindings=[];this.handlers=[]}f=f||{};
var k=g.console||{};"function"!==typeof k.log&&(k.log=Function.prototype.valueOf());"function"!==typeof k.warn&&(k.warn=k.log||Function.prototype.valueOf());Array.prototype.forEach||(Array.prototype.forEach=function(a,c,b){if(!a)throw Error("forEach: Array is null or undefined.");if("function"!==typeof c)throw Error("forEach: Iterator is not callable.");var d=a.length>>>0,e=0;for(b=b||null;e<d;)Object.prototype.hasOwnProperty.call(a,e)&&c.call(b,a[e],e,a),e++});Array.prototype.map||(Array.prototype.map=
function(a,c){var b=[];a.forEach(function(a,e,f){b.push(c.call(null,a,e,f))});return b});Array.prototype.filter||(Array.prototype.filter=function(a,c,b){if("function"!==typeof c)throw Error("Predicate is not callable.");var d=[];a.forEach(function(a,e,f){c.call(b,a,e,f)&&d.push(a)});return d});Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var c=Object(this),b=c.length>>>0;if(0===b)return-1;var d=0;0<arguments.length&&(d=Number(arguments[1]),d!=d?
d=0:0!==d&&(Infinity!=d&&-Infinity!=d)&&(d=(0<d||-1)*Math.floor(Math.abs(d))));if(d>=b)return-1;for(d=0<=d?d:Math.max(b-Math.abs(d),0);d<b;d++)if(d in c&&c[d]===a)return d;return-1});b.internals={};b.internals.keymap={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,
"Numpad 8":104,"Numpad 9":105,Multiply:106,Add:107,Subtract:109,Decimal:110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F11:122,F12:123,F13:124,F14:125,F15:126,Backspace:8,Tab:9,Enter:13,SHIFT:16,CTRL:17,ALT:18,META:91,META_RIGHT:93,"Caps Lock":20,Esc:27,Spacebar:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,"Num Lock":144,ScrLk:145,"Pause/Break":19,"; :":186,"= +":187,"- _":189,"/ ?":191,"` ~":192,"[ {":219,"\\ |":220,
"] }":221,"\" '":222,",":188,".":190,"/":191};for(var n in b.internals.keymap)b[n]=new b(n,b.internals.keymap[n]);b.fromName=function(a){return(a=b[a])&&a instanceof b?a:null};b.fromCode=function(a){for(var c in b.internals.keymap)if(b.internals.keymap[c]===a)return b[c];return null};b.prototype.isPressed=function(a){return this.code===a};b.prototype.isMeta=function(){switch(this.code){case b.CTRL:case b.SHIFT:case b.ALT:case b.META:case b.META_RIGHT:return!0;default:return!1}};b.prototype.eq=function(a){return this.code===
a.code&&this.name===a.name};f.Key=b;e.prototype.toString=function(){return(this.ctrl?"CTRL+":"")+(this.alt?"ALT+":"")+(this.shift?"SHIFT+":"")+(this.meta?"META+":"")+(key&&key.name?key.name:"")};e.prototype.serialize=function(){if("undefined"===typeof JSON)throw Error("Your browser does not currently support JSON serialization.");return JSON.stringify(this)};e.deserialize=function(a){if("undefined"===typeof JSON)throw Error("Your browser does not currently support JSON deserialization.");return JSON.parse(a)};
e.prototype.clone=function(){var a=new e(this.key);a.ctrl=this.ctrl;a.alt=this.alt;a.shift=this.shift;a.meta=this.meta;return a};e.fromObject=function(a){if(!a||!a.key)throw Error("Combo.fromObject: Cannot create Combo from provided object");var c=new b(a.key.name,a.key.code),c=new e(c);c.ctrl=a.ctrl||!1;c.alt=a.alt||!1;c.shift=a.shift||!1;c.meta=a.meta||!1;return c};e.fromEvent=function(a){var c=new e(b.fromCode(a.which));c.shift=c.shift||a.shiftKey;c.alt=c.alt||a.altKey;c.meta=c.meta||a.metaKey;
c.ctrl=c.ctrl||a.ctrlKey;return c};e.fromString=function(a){a=a.split("+");if(1<=a.length){var c=new e(b.fromName(a[a.length-1]));c.ctrl=-1<a.indexOf("CTRL");c.alt=-1<a.indexOf("ALT");c.shift=-1<a.indexOf("SHIFT");c.meta=-1<a.indexOf("META")||-1<a.indexOf("META_RIGHT");return c}throw Error("Combo.fromString: Invalid string");};e.prototype.isMatch=function(a,c){if(!a)throw Error("Combo.isMatch called without a combo to match against.");if(this.key.isMeta()){if((this.shift||this.key.eq(b.SHIFT))&&!a.shift||
(this.alt||this.key.eq(b.ALT))&&!a.alt||(this.ctrl||this.key.eq(b.CTRL))&&!a.ctrl||(this.meta||this.key.eq(b.META)||this.key.eq(b.META_RIGHT))&&!a.meta)return!1}else if(!c&&!this.key.eq(a.key)||this.shift&&!a.shift||this.alt&&!a.alt||this.ctrl&&!a.ctrl||this.meta&&!a.meta)return!1;return!0};e.prototype.requires=function(a){if("number"!==typeof a)throw Error("Combo.requires: `which` must be a keycode (number)");return this.key.code===a?!0:this.ctrl&&this.key.eq(b.CTRL)?!0:this.shift&&this.key.eq(b.SHIFT)?
!0:this.alt&&this.key.eq(b.ALT)?!0:this.meta&&(this.key.eq(b.META)||key.eq(b.META_RIGHT))?!0:!1};e.prototype.containsMetaKeys=function(){return this.ctrl||this.shift||this.alt||this.meta||this.key.isMeta()};f.Combo=e;h.prototype.get=function(a){return l(this.bindings,function(c){return c.name===a})};h.prototype.add=function(a,c){if(!a||!c)throw Error("Keybindings.add: Invalid arguments provided");if(!(c instanceof e))throw Error("Keybindings.add: `combo` must be an instance of Combo");var b=l(this.bindings,
function(c){return c.name===a});b?b.combo=c:this.bindings.push({name:a,combo:c})};h.prototype.registerHandler=function(a,c,b){2===arguments.length&&"function"===typeof c&&(b=c,c="keydown");if(!a||!c||!b||"function"!==typeof b)throw Error("Keybindings.registerHandler: Invalid arguments provided");this.handlers.push({name:a,eventType:c,handler:b})};h.prototype.registerToggle=function(a,c,b){if(3!==arguments.length)throw Error("Keybindings.registerToggle: You must provide all three arguments to this function.");
this.handlers.push({name:a,eventType:"keydown",handler:function(){var a=!1;return function(){var e=Array.prototype.slice.call(arguments);a?(a=!1,b.apply(null,e)):(a=!0,c.apply(null,e))}}()})};h.prototype.serialize=function(){if("undefined"===typeof JSON)throw Error("Your browser does not support JSON serialization.");return JSON.stringify(this)};h.prototype.deserialize=function(a){if("undefined"===typeof JSON)throw Error("Your browser does not support JSON serialization.");a=JSON.parse(a);if(!a||
!a.bindings||a instanceof Array)throw Error("Keybindings.deserialize: Unable to deserialize keybindings");this.bindings=a.bindings.map(function(a){a.combo=e.fromObject(a.combo);return a})};h.prototype.getHandlersForCombo=function(a,b){var e=this.bindings.filter(function(d){return b?d.combo.isMatch(a,!0):d.combo.isMatch(a)});return this.handlers.filter(function(a){return l(e,function(b){return b.name===a.name||b.name===a.name.replace("$$META","")})})};f.Bindings=h;return f});
